<div class="video-form-container dialog-mode">
    
    <div class="form-header">
        <div class="header-title">
            <h1>{{ isEditMode ? 'Edit Video' : 'Create New Video' }}</h1>
            <p>Manage your video content details and media assets</p>
        </div>
        <div class="header-actions">
            <button mat-icon-button (click)="closeDialog()" matTooltip="Close">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <div class="form-content">
        <form [formGroup]="videoForm">
            
            <div class="section">
                <h2 class="section-title">
                    <mat-icon>movie_creation</mat-icon>
                    Movie Details
                </h2>

                <div class="form-grid">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Movie Title</mat-label>
                        <mat-icon matPrefix>title</mat-icon>
                        <input matInput formControlName="title" placeholder="Ex: Inception" required>
                        <mat-error *ngIf="videoForm.get('title')?.hasError('required')">Title is required</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Synopsis / Description</mat-label>
                        <textarea matInput rows="4" formControlName="description" placeholder="Enter movie plot..." required></textarea>
                        <mat-error *ngIf="videoForm.get('description')?.hasError('required')">Description is required</mat-error>
                    </mat-form-field>

                    <div class="info-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Release Year</mat-label>
                            <mat-icon matPrefix>calendar_today</mat-icon>
                            <input matInput type="number" formControlName="year" required>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Rating</mat-label>
                            <mat-icon matPrefix>star</mat-icon>
                            <mat-select formControlName="rating" required>
                                <mat-option *ngFor="let rate of ratings" [value]="rate">{{ rate }}</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Genres</mat-label>
                            <mat-icon matPrefix>category</mat-icon>
                            <mat-select formControlName="categories" multiple required>
                                <mat-select-trigger>
                                    {{videoForm.get('categories')?.value?.[0] || ''}}
                                    <span *ngIf="(videoForm.get('categories')?.value?.length || 0) > 1" class="additional-selection">
                                      (+{{(videoForm.get('categories')?.value?.length || 0) - 1}} {{videoForm.get('categories')?.value?.length === 2 ? 'other' : 'others'}})
                                    </span>
                                </mat-select-trigger>
                                <mat-option *ngFor="let cat of categoriesAll" [value]="cat">{{ cat }}</mat-option>
                            </mat-select>
                            <mat-error *ngIf="videoForm.get('categories')?.hasError('required')">Select at least one genre</mat-error>
                        </mat-form-field>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">
                    <mat-icon>perm_media</mat-icon>
                    Media Assets
                </h2>

                <div class="media-grid">
                    
                    <div class="media-upload-card">
                        <div class="upload-header">
                            <mat-icon>videocam</mat-icon>
                            <span>Video Source</span>
                            <span class="required">*</span>
                        </div>

                        <div class="upload-progress" *ngIf="uploadProgress > 0 && uploadProgress < 100">
                            <mat-progress-bar mode="determinate" [value]="uploadProgress"></mat-progress-bar>
                            <span class="progress-text">Uploading Video... {{uploadProgress}}%</span>
                        </div>

                        <div class="upload-area" *ngIf="!videoForm.get('src')?.value && !uploadProgress">
                            <input type="file" #videoInput accept="video/*,.mkv,.mp4,.avi" (change)="onVideoPlicked($event)">
                            <div class="upload-label" (click)="videoInput.click()">
                                <mat-icon class="upload-icon">cloud_upload</mat-icon>
                                <span class="upload-text">Click to upload Video</span>
                                <span class="upload-hint">MP4, MKV (Max 2GB)</span>
                            </div>
                        </div>

                        <div class="video-preview" *ngIf="videoForm.get('src')?.value && videoPreviewUrl">
                            <video [src]="videoPreviewUrl" controls controlsList="nodownload" class="preview-video" preload="metadata"></video>
                            <button mat-icon-button class="remove-btn" (click)="removeVideo()" matTooltip="Remove Video">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        
                        <mat-error *ngIf="videoForm.get('src')?.touched && videoForm.get('src')?.invalid && !uploadProgress" style="margin-top: 10px; display:block; font-size:12px;">
                            Video file is required
                        </mat-error>
                    </div>

                    <div class="media-upload-card">
                        <div class="upload-header">
                            <mat-icon>image</mat-icon>
                            <span>Poster Image</span>
                            <span class="required">*</span>
                            <span class="optional">(Vertical)</span>
                        </div>

                         <div class="upload-progress" *ngIf="posterProgress > 0 && posterProgress < 100">
                            <mat-progress-bar mode="determinate" color="accent" [value]="posterProgress"></mat-progress-bar>
                            <span class="progress-text">Uploading Poster... {{posterProgress}}%</span>
                        </div>

                        <div class="upload-area portrait" *ngIf="!videoForm.get('poster')?.value && !posterProgress">
                            <input type="file" #posterInput accept="image/*" (change)="onPosterPicked($event)">
                            <div class="upload-label" (click)="posterInput.click()">
                                <mat-icon class="upload-icon">add_photo_alternate</mat-icon>
                                <span class="upload-text">Upload Poster</span>
                                <span class="upload-hint">JPG, PNG (2:3 Ratio)</span>
                            </div>
                        </div>

                        <div class="poster-preview" *ngIf="videoForm.get('poster')?.value && posterPreviewUrl">
                            <img [src]="posterPreviewUrl" class="preview-poster" alt="Poster">
                            <button mat-icon-button class="remove-btn" (click)="removePoster()" matTooltip="Remove Poster">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>

                        <mat-error *ngIf="videoForm.get('poster')?.touched && videoForm.get('poster')?.invalid && !posterProgress" style="margin-top: 10px; display:block; font-size:12px;">
                            Poster is required
                        </mat-error>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="publish-card">
                    <div class="publish-info">
                        <mat-icon [class.active]="videoForm.value.published">
                            {{ videoForm.value.published ? 'check_circle' : 'unpublished' }}
                        </mat-icon>
                        <div class="publish-text">
                            <h3>{{ videoForm.value.published ? 'Video is Published' : 'Video is Draft' }}</h3>
                            <p>{{ videoForm.value.published ? 'Video is visible to all users' : 'Video is only visible to admins' }}</p>
                        </div>
                    </div>
                    <mat-slide-toggle formControlName="published" color="primary"></mat-slide-toggle>
                </div>
            </div>

        </form>
    </div>

    <div class="form-footer">
        <div class="footer-content">
            <button mat-button class="footer-cancel" (click)="closeDialog()" [disabled]="isSaving">
                Cancel
            </button>
            
            <button mat-raised-button color="warn" class="footer-save" (click)="onSave()" 
                    [disabled]="videoForm.invalid || isSaving || (uploadProgress > 0 && uploadProgress < 100) || (posterProgress > 0 && posterProgress < 100)">
                <mat-icon *ngIf="!isSaving">save</mat-icon>
                <mat-spinner *ngIf="isSaving" diameter="20"></mat-spinner>
                <span>{{ isSaving ? 'Saving...' : (isEditMode ? 'Update Video' : 'Save Video') }}</span>
            </button>
        </div>
    </div>
</div>